<!-- Navbar -->
<nav class="navbar" id="navbar">
  <div class="left" style="display: flex; align-items: center">
    <img
      src="assets/user-profile.png"
      alt="Perfil"
      routerLink="/dashteste"
      class="profile-img"
      style="width: 85px; height: 85px; border-radius: 50%; cursor: pointer"
    />
    <div class="greeting">
      <div>Olá, {{ usuarioService.nomeUsuario || "..." }}</div>
      <small>{{ dataHoje }}</small>
    </div>
  </div>

  <div
    class="right"
    style="
      display: flex;
      align-items: flex-end;
      gap: 0.5rem;
      padding-bottom: 0.25px;
      margin-top: 20px;
    "
  >
    <div
      class="notificacao-wrapper"
      (mouseenter)="abrirNotificacao()"
      (mouseleave)="fecharNotificacao()"
      style="margin-right: 0.625rem"
    >
      <img
        src="assets/notificacao.png"
        alt="Notificações"
        class="notificacao"
        style="width: 2.25rem; cursor: pointer; transform: translateY(2px)"
      />
      <div class="notificacao-popup" *ngIf="mostrarNotificacoes">
        <div *ngFor="let n of notificacoes" class="notificacao-card">
          <div class="notificacao-imagem">
            <img
              [src]="n.imagemUrl"
              alt="Imagem"
              style="width: 100%; height: 100%"
            />
          </div>
          <div class="notificacao-conteudo">
            <strong>{{ n.titulo }}</strong>
            <small>{{ n.descricao }}</small>
          </div>
          <div
            *ngIf="usuarioService.usuarioEhAdmin()"
            style="
              display: flex;
              align-items: center;
              gap: 0.3rem;
              margin-left: auto;
            "
          >
            <span
              class="icone-acao editar notificacao"
              title="Editar notificação"
              style="font-size: 17px"
              (click)="editarNotificacao(n)"
              >✎</span
            >
            <span
              class="icone-acao apagar notificacao"
              title="Remover notificação"
              style="font-weight: bold"
              (click)="confirmarRemocao(n)"
              >✕</span
            >
          </div>
        </div>
        <div
          class="nova-notificacao"
          *ngIf="usuarioService.usuarioEhAdmin()"
          (click)="abrirFormularioNotificacao()"
        >
          + Nova notificação
        </div>
      </div>
      <div
        class="formulario-modal"
        *ngIf="mostrarFormulario && usuarioService.usuarioEhAdmin()"
      >
        <h3 style="color: black; margin-top: 0">Nova Notificação</h3>
        <input
          type="text"
          2025-08-18
          10:48:33
          [(ngModel)]="nova.titulo"
          class="form-control"
          placeholder="Título da notificação"
          style="width: 100%"
        />
        <textarea
          [(ngModel)]="nova.descricao"
          class="form-control"
          placeholder="Descrição da notificação"
          style="width: 100%; resize: none"
          rows="3"
        ></textarea>
        <input
          style="color: black"
          type="file"
          (change)="onFileChange($event)"
        />
        <div class="botoes-container">
          <button class="cancelar" (click)="cancelarFormulario()">
            Cancelar
          </button>
          <button
            class="salvar"
            (click)="salvarNotificacao()"
            [disabled]="
              !nova.titulo.trim() || !nova.descricao.trim() || !nova.imagemUrl
            "
          >
            Salvar
          </button>
        </div>
      </div>
    </div>
    <div
      class="dropdown"
      (mouseenter)="abrirMenu()"
      (mouseleave)="fecharMenu()"
    >
      <div class="dropdown-toggle">☰</div>
      <ul class="dropdown-menu" *ngIf="menuAberto">
        <li><a routerLink="/menu">Perfil</a></li>
        <li><a routerLink="/galeria">Galeria</a></li>
        <li><a routerLink="/produtos">Produtos</a></li>
        <li><a routerLink="/meus-horarios">Meus Horários</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container-horarios">
  <div class="coluna-esquerda">
    <h3>Selecione os Serviços:</h3>
    <div *ngFor="let servico of servicos" class="servico-item">
      <label class="checkbox-container">
        <input
          type="checkbox"
          [checked]="servicosSelecionados.includes(servico.id!)"
          (change)="toggleServico(servico.id!, $event)"
        />
        <span class="checkmark"></span>
        <span class="servico-nome">{{ servico.nome }}</span>
        <span class="servico-preco">R$ {{ servico.preco.toFixed(2) }}</span>
      </label>
    </div>
  </div>

  <!-- COLUNA DIREITA - HORÁRIOS -->
  <div class="coluna-direita">
    <h3>
      Horários Disponíveis -
      <select
        [(ngModel)]="barbeiroSelecionado"
        (change)="onBarbeiroChange()"
        class="seletor-barbeiro"
      >
        <option *ngFor="let b of barbeiros" [ngValue]="b">
          {{ b }}
        </option>
      </select>
    </h3>

    <!-- BOTÕES DOS DIAS -->
    <div class="dias-semana" [class.admin]="usuarioService.usuarioEhAdmin()">
      <button
        *ngFor="let dia of diasSemana"
        [ngClass]="{ ativo: dia.sigla === diaSelecionado }"
        (click)="selecionarDia(dia.sigla)"
      >
        {{ dia.sigla }}
      </button>
    </div>

    <!-- Painel Admin -->
    <div *ngIf="usuarioService.usuarioEhAdmin()">
      <div
        style="
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 10px;
        "
      >
        <label style="display: flex; align-items: center; gap: 5px">
          <input
            type="checkbox"
            [(ngModel)]="selecionarTodos"
            (change)="toggleSelecionarTodos()"
          />
          Selecionar todos
        </label>
        <button
          (click)="bloquearHorariosSelecionados()"
          [disabled]="horariosSelecionadosParaBloqueio.size === 0"
          class="des-blok"
        >
          Bloquear
        </button>
        <button
          (click)="desbloquearHorariosSelecionados()"
          [disabled]="horariosSelecionadosParaDesbloqueio.size === 0"
          class="des-blok"
        >
          Desbloquear
        </button>
      </div>
      <div class="acoes" style="margin-bottom: 5px">
        <button (click)="abrirFormularioHorario()">+ Adicionar Horário</button>
        <button
          (click)="apagarHorariosSelecionados()"
          [disabled]="horariosSelecionados.size === 0"
          class="apagar"
        >
          Apagar
        </button>
      </div>
    </div>

    <!-- MENSAGEM SE FOR DOMINGO -->
    <div
      *ngIf="diaSelecionado === 'DOM'"
      class="mensagem-fechado"
      style="margin-top: 25px"
    >
      <p style="color: red; font-weight: bold; text-align: center">
        Não estamos aberto aos Domingos. Que tal um outro dia?
      </p>
    </div>

    <!-- PERÍODOS -->
    <ng-container *ngIf="diaSelecionado !== 'DOM'">
      <ng-container *ngFor="let periodo of periodos">
        <div class="periodo" style="margin-top: 25px">
          <h4>{{ periodo | titlecase }}</h4>
          <div class="horarios">
            <ng-container
              *ngFor="let horario of obterHorariosPorPeriodo(periodo)"
            >
              <div class="horario-container">
                <button
                  class="horario"
                  type="button"
                  [ngClass]="{
                    selecionado: usuarioService.usuarioEhAdmin()
                      ? horariosSelecionados.has(horario.id!)
                      : horarioSelecionadoCliente?.horario === horario.horario,
                    bloqueado: horario.bloqueado,
                    passado: isHorarioPassado(horario),
                    'admin-bloqueio':
                      usuarioService.usuarioEhAdmin() &&
                      (horariosSelecionadosParaBloqueio.has(horario.id!) ||
                        horariosSelecionadosParaDesbloqueio.has(horario.id!))
                  }"
                  [disabled]="
                    !usuarioService.usuarioEhAdmin() &&
                    (horario.bloqueado || isHorarioPassado(horario))
                  "
                  (click)="clicarHorario(horario)"
                >
                  {{ formatarHorario(horario.horario) }}
                  <span
                    class="editar"
                    *ngIf="usuarioService.usuarioEhAdmin()"
                    (click)="
                      abrirFormularioEditarHorario(horario);
                      $event.stopPropagation()
                    "
                  >
                    ✎
                  </span>
                </button>
              </div>
            </ng-container>
          </div>
        </div>
      </ng-container>
    </ng-container>

    <!-- RESUMO DE AGENDAMENTO -->
    <div class="resumo-agendamento">
      <h3>Resumo do Agendamento</h3>
      <p><strong>Barbeiro:</strong> {{ resumo.barbeiro }}</p>
      <p style="margin-left: -2px">
        <strong>Serviços:</strong> {{ obterNomesServicos() }}
      </p>
      <p><strong>Data:</strong> {{ resumo.data || "Não selecionada" }}</p>
      <p><strong>Horário:</strong> {{ resumo.horario || "Não selecionado" }}</p>
      <br />
      <p style="margin-left: -2px">
        <strong>Subtotal:</strong> R$ {{ resumo.subtotal | number : "1.2-2" }}
      </p>
      <!-- <p>
        <strong>Desconto:</strong> R$ {{ resumo.desconto | number : "1.2-2" }}
      </p> -->
      <p style="margin-left: -2px">
        <strong>Total:</strong> R$ {{ resumo.total | number : "1.2-2" }}
      </p>
      <!-- <p><strong>Cupom:</strong> {{ resumo.cupomNome || "Nenhum" }}</p> -->
      <button (click)="confirmar()">Confirmar Agendamento</button>
    </div>

    <!-- FORMULÁRIO POPUP DE HORÁRIO -->
    <div
      *ngIf="usuarioService.usuarioEhAdmin() && mostrarFormularioHorario"
      class="formulario-horario-popup"
    >
      <form (ngSubmit)="modoEdicao ? editarHorario() : criarHorario()">
        <label for="barbeiro">Barbeiro:</label>
        <select
          id="barbeiro"
          [(ngModel)]="barbeiroFormulario"
          name="barbeiro"
          required
        >
          <option value="Felipe">Felipe</option>
          <option value="Ezequiel">Ezequiel</option>
        </select>
        <label for="horario">Horário:</label>
        <input
          type="time"
          id="horario"
          [(ngModel)]="novoHorario"
          name="horario"
          required
        />
        <div class="formulario-botoes">
          <button
            type="button"
            class="btn-cancelar"
            (click)="cancelarFormularioHorario()"
          >
            Cancelar
          </button>
          <button type="submit" class="btn-salvar">
            {{ modoEdicao ? "Salvar Alteração" : "Adicionar Horário" }}
          </button>
        </div>
      </form>
    </div>

    <!-- POPUP DE CUPOM -->
    <div
      class="popup"
      *ngIf="mostrarPopupCupom"
      (click)="fecharPopupCupom($event)"
    >
      <div class="popup-conteudo" (click)="$event.stopPropagation()">
        <h3>Cupons fidelidade</h3>
        <div class="cupom-resgatar-container">
          <input
            type="text"
            class="cupom-input"
            placeholder="Digite o código"
            [(ngModel)]="codigoCupom"
          />
          <button class="botao-resgatar" (click)="resgatarCupom()">
            Resgatar
          </button>
        </div>
        <ul>
          <li
            *ngFor="let cupom of cuponsDisponiveis"
            (click)="selecionarCupomPopup(cupom)"
            [class.selecionado]="cupomSelecionadoId === '' + cupom.id"
            class="cupom-opcao"
          >
            <img [src]="cupom.imagem" alt="Cupom" />
            <div class="conteudo">
              <p class="titulo">{{ cupom.nome }}</p>
              <p class="descricao">{{ cupom.descricao }}</p>
            </div>
            <span class="icone-info">i</span>
          </li>
          <li
            class="cupom-opcao nenhum"
            (click)="selecionarCupomPopup(null)"
            [class.selecionado]="!cupomSelecionadoId"
          >
            Não adicionar cupom
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- BARRA INFERIOR MOBILE -->
<div class="bottom-nav">
  <a routerLink="/dashboard" class="nav-item">
    <img src="assets/inicio.png" alt="Início" width="38px" height="32px" />
    <span>Início</span>
  </a>
  <a routerLink="/galeria" class="nav-item">
    <img src="assets/galeria.png" alt="Galeria" width="34px" height="33px" />
    <span>Galeria</span>
  </a>
  <a routerLink="/agendamento" class="nav-item">
    <img
      src="assets/agendamento-ativa.png"
      alt="Agendamentos"
      width="34px"
      height="34px"
    />
    <span style="color: #f46d25; font-weight: bold">Agendamentos</span>
  </a>
  <a routerLink="/produtos" class="nav-item">
    <img src="assets/produto.png" alt="Produtos" width="30px" height="30px" />
    <span>Produtos</span>
  </a>
  <a class="nav-item" (click)="abrirMenuMobile()">
    <img src="assets/user-profile.png" alt="Menu" width="40px" height="40px" />
    <span>Menu</span>
  </a>
</div>

<!-- POP-UP DE MENU MOBILE -->
<div
  class="menu-mobile-popup"
  *ngIf="mostrarMenuMobile"
  (click)="fecharMenuMobile($event)"
>
  <div class="menu-mobile-content" (click)="$event.stopPropagation()">
    <ul class="menu-mobile-lista">
      <li>
        <a routerLink="/perfil" (click)="fecharMenuMobile()">Perfil</a>
      </li>
      <li>
        <a routerLink="/meus-horarios" (click)="fecharMenuMobile()"
          >Meus horarios</a
        >
      </li>
      <li><a (click)="logout(); fecharMenuMobile()">Sair</a></li>
    </ul>
  </div>
</div>
